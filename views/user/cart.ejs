<%- include ("../partials/user/header") %>

<div class="container-fluid pt-5">
    <div class="row px-xl-5">
        <!-- Cart Items Table -->
        <div class="col-lg-8 table-responsive mb-5">
            <table class="table table-bordered text-center mb-0">
                <thead class="bg-secondary text-dark">
                    <tr>
                        <th>Products</th>
                        <th>Price</th>
                        <th>Size</th>
                        <th>Quantity</th>
                        <th>Total</th>
                        <th>Remove</th> > 
                    </tr>
                </thead>
                <tbody class="align-middle">
                    <% if (cartItems && cartItems.length > 0) { %>
                      <% cartItems.forEach((item) => { %>
                        <tr>
                          <td class="align-middle">
                            <img src="<%= item.product.images[0] %>" alt="" style="width: 50px;">
                            <%= item.product.productName %>
                          </td>
                          <td class="align-middle">$<%= item.product.regularPrice %></td>
                          <td class="align-middle"><%= item.size %></td>
                          <td class="align-middle">
                            <div class="input-group quantity mx-auto" style="width: 100px;">
                              <div class="input-group-btn">
                                <button class="btn btn-sm btn-primary btn-plus" data-item-id="<%= item._id %>" data-action="increase">
                                  <i class="fa fa-plus"></i>
                                </button>
                              </div>
                              <input
                                type="text"
                                id="quantity-<%= item._id %>"
                                class="form-control form-control-sm bg-secondary text-center"
                                value="<%= item.quantity %>"
                                min="1"
                                max="10"
                                readonly
                              />
                              <div class="input-group-btn">
                                <button class="btn btn-sm btn-primary btn-minus" data-item-id="<%= item._id %>" data-action="decrease">
                                  <i class="fa fa-minus"></i>
                                </button>
                              </div>
                            </div>
                          </td>
                          <td class="align-middle" id="item-total-<%= item._id %>">$<%= item.quantity * item.product.regularPrice %></td>
                          <td class="align-middle">
                            <a href="/cart/remove/<%= item._id %>" class="btn btn-sm btn-primary">
                              <i class="fa fa-times"></i>
                            </a>
                          </td>
                        </tr>
                      <% }); %>
                    <% } else { %>
                      <tr>
                        <td colspan="6" class="text-center">Your cart is empty.</td>
                      </tr>
                    <% } %>
                  </tbody>
            </table>
        </div>

        
    <div class="col-lg-4">
    <form class="mb-5" action="/cart/apply-coupon" method="POST">
        <div class="input-group">
            <input type="text" name="couponCode" class="form-control p-4" placeholder="Coupon Code">
            <div class="input-group-append">
                <button class="btn btn-primary">Apply Coupon</button>
            </div>
        </div>
    </form>
    <div class="card border-secondary mb-5">
    <div class="card-header bg-secondary border-0">
        <h4 class="font-weight-semi-bold m-0">Cart Summary</h4>
    </div>
    <div class="card-body">
        <div class="d-flex justify-content-between mb-3 pt-1">
            <h6 class="font-weight-medium">Subtotal</h6>
            <h6 class="font-weight-medium cart-summary-subtotal">$<%= totalPrice %>.00</h6>
        </div>
        <div class="d-flex justify-content-between">
            <h6 class="font-weight-medium">Shipping</h6>
            <h6 class="font-weight-medium cart-summary-shipping">
                $<%= totalPrice > 1000 ? 500 : 150 %>.00
            </h6>
        </div>
        <div class="d-flex justify-content-between mt-2">
            <h5 class="font-weight-bold">Total</h5>
            <h5 class="font-weight-bold cart-summary-total">
                $<%= totalPrice > 1000 ? totalPrice + 500 : totalPrice + 150 %>.00
            </h5>
        </div>
    </div>
    <div class="card-footer border-secondary bg-transparent">
        <a href="/checkout" class="btn btn-block btn-primary my-3 py-3">Proceed To Checkout</a>
    </div>
</div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const plusButtons = document.querySelectorAll('.btn-plus');
    const minusButtons = document.querySelectorAll('.btn-minus');
    const subtotalElement = document.querySelector('.cart-summary-subtotal');
    const shippingElement = document.querySelector('.cart-summary-shipping');
    const totalElement = document.querySelector('.cart-summary-total');

    function updateQuantity(itemId, action) {
      const quantityInput = document.getElementById(`quantity-${itemId}`);
      const itemTotal = document.getElementById(`item-total-${itemId}`);
      let quantity = parseInt(quantityInput.value);

      if (action === 'increase' && quantity < 10) {
        quantity++;
      } else if (action === 'decrease' && quantity > 1) {
        quantity--;
      }

      // Update quantity in the input field
      quantityInput.value = quantity;

      // Fetch API to update quantity in the database
      fetch(`/cart/update/${itemId}`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ quantity }),
      })
        .then(response => response.json())
        .then(data => {
          console.log(`QTY WORKING ? : ${data.quantity}`);
          
          // Update individual item total
          itemTotal.textContent = `$${(data.quantity * data.productPrice).toFixed(2)}`;
          
          // Update cart summary
          subtotalElement.textContent = `$${data.cartSubtotal.toFixed(2)}`;
          
          // Update shipping
          const shippingCost = data.cartSubtotal > 1000 ? 500 : 150;
          shippingElement.textContent = `$${shippingCost.toFixed(2)}`;
          
          // Update total
          totalElement.textContent = `$${(data.cartSubtotal + shippingCost).toFixed(2)}`;
        })
        .catch(error => console.error('Error updating cart:', error));
    }

    plusButtons.forEach(button => {
      button.addEventListener('click', function() {
        const itemId = button.getAttribute('data-item-id');
        updateQuantity(itemId, 'increase');
      });
    });

    minusButtons.forEach(button => {
      button.addEventListener('click', function() {
        const itemId = button.getAttribute('data-item-id');
        updateQuantity(itemId, 'decrease');
      });
    });
  });
</script>


  
<%- include ("../partials/user/footer") %>